# Importing in.relation.to

The scripts in this directory allow you to create required input files to migrate
the exiting in.relation.to blog to awestruct.
The scripts will crawl the site and save all *.lace urls into a Ruby PStore.
From there erb files for the awestruct site can be created. Besides of this the scripts
generate a input file to migrate comments to Disqus as well as redirect files for
old to new URLs.

## How to run the scripts

### Quickstart

    # install bundler
    > gem install bundler

    # get your dependencies via bundler
    > bundle install

    # run the crawler
    > bundle exec ./crawler.rb -u http://in.relation.to -p ".*\.lace" -o posts.pstore | tee crawl.log

    # run the importer (creates erb files, Apache redirects and Disqus WXR import file)
    > bundle exec ./importer.rb -s posts.pstore -o ../posts

    # for experiments when you don't want to download images (-ni) and assets (-na)
    > bundle exec ./importer.rb -s posts.pstore -o ../posts -ni -na


### Crawling in.relation.to

That's the first step in the in.relation.to migration. We crawl the site to extract
the HTML for the blog posts and use it to run through an importer to create the
awestruct files. The data is stored in a [PStore](http://ruby-doc.org/stdlib-2.1.2/libdoc/pstore/rdoc/PStore.html) file.

    > bundle exec ./crawler.rb -u http://in.relation.to -p ".*\.lace" -o posts.pstore | tee crawl.log

The version used for creating the awestruct site is added to this directory and
called [posts.pstore.bz2](./posts.pstore.bz2). It is BZIP2 compressed and can be
uncompressed via

    > bunzip2 posts.pstore.bz2

### Creating ERB files

Once you have the PStore file you can run the importer to create the [ERB](http://www.stuartellis.eu/articles/erb/) files. Using ERB we can keep the original HTML and don't
have to parse it to for example create Markdown.

    > bundle exec ./importer.rb -s posts.pstore -o ../posts

### Creating Disqus WXR import file

Blog comments are also part of the data stored in the PStore file. The comments can be extracted into a XML file which is suited for
[importing into Disqus](https://help.disqus.com/customer/portal/articles/472150-custom-xml-import-format).

    > bundle exec ./importer.rb -s posts.pstore -o ../posts -wxr wxr.xml -e

### Creating Apache re-directs

The scripts also generates redirect instructions for Apache to map old URLs to new ones.
There are three parts to this (all these fragments are committed under "redirects"):

* Redirects for blog posts and tags; Generated by importer.rb:

    > bundle exec ./importer.rb -s posts.pstore -o ../posts -rf ../redirects/.htaccess_posts

* Redirects for blogger homes; Generated by user_redirect_creator.rb:

    > bundle exec ./user_redirect_creator.rb -s users.pstore -o ../redirects/.htaccess_bloggers

* Additional manually created redirects in ../redirects/.htaccess_misc

To merge the fragments into one .htaccess or include file for the main HTTPD config run:

    > cat ../redirects/.htaccess_misc ../redirects/.htaccess_bloggers ../redirects/.htaccess_posts > .htaccess

To create the users.pstore file, run the crawler like so:

    bundle exec ./crawler.rb -u "http://in.relation.to/Bloggers/Ales, \
    http://in.relation.to/Bloggers/Aslak, \
    http://in.relation.to/Bloggers/Brett, \
    http://in.relation.to/Bloggers/Christian, \
    http://in.relation.to/Bloggers/Dan, \
    http://in.relation.to/Bloggers/Daniel, \
    http://in.relation.to/Bloggers/David, \
    http://in.relation.to/Bloggers/Davide, \
    http://in.relation.to/Bloggers/Emmanuel, \
    http://in.relation.to/Bloggers/Gail, \
    http://in.relation.to/Bloggers/Gavin, \
    http://in.relation.to/Bloggers/Gleb, \
    http://in.relation.to/Bloggers/Greg, \
    http://in.relation.to/Bloggers/Gunnar, \
    http://in.relation.to/Bloggers/Hardy, \
    http://in.relation.to/Bloggers/Ilya, \
    http://in.relation.to/Bloggers/Jason, \
    http://in.relation.to/Bloggers/JasonP, \
    http://in.relation.to/Bloggers/Jay, \
    http://in.relation.to/Bloggers/Jesper, \
    http://in.relation.to/Bloggers/John, \
    http://in.relation.to/Bloggers/Jozef, \
    http://in.relation.to/Bloggers/Ken, \
    http://in.relation.to/Bloggers/Lincoln, \
    http://in.relation.to/Bloggers/Luksa, \
    http://in.relation.to/Bloggers/Marek, \
    http://in.relation.to/Bloggers/Marius, \
    http://in.relation.to/Bloggers/Marko, \
    http://in.relation.to/Bloggers/Martin, \
    http://in.relation.to/Bloggers/Max, \
    http://in.relation.to/Bloggers/Michael, \
    http://in.relation.to/Bloggers/Nicklas, \
    http://in.relation.to/Bloggers/Norman, \
    http://in.relation.to/Bloggers/Pete, \
    http://in.relation.to/Bloggers/Robb, \
    http://in.relation.to/Bloggers/Sanne, \
    http://in.relation.to/Bloggers/Scott, \
    http://in.relation.to/Bloggers/Sergey, \
    http://in.relation.to/Bloggers/Shane, \
    http://in.relation.to/Bloggers/Snjezana, \
    http://in.relation.to/Bloggers/Steve, \
    http://in.relation.to/Bloggers/StrongLiu, \
    http://in.relation.to/Bloggers/Stuart, \
    http://in.relation.to/Bloggers/Tihomir" \
    -p ".*" -o users.pstore -d 0

## Tips & Tricks

* To nicely format the generated WXR XML file you can use

        xmllint --format --recover <export-file-name>.xml

* When experimenting with the importer it is often nice to start from a clean state. Just run to reset your checkout:

        git clean -f -d

* To list all available script options use '-h'

        > ./crawler.rb -h
        Usage: crawler.rb [-upoh]
        Application options:
        Required:
          -u, --url=<file>                 The base url
          -p, --pattern=<regexp>           Regular expression to limit the discovered pages
          -o, --out=<file>                 The name of the output-file
        Common:
          -h, --help                       Show this message.

        > ./importer.rb -h
        Usage: importer.rb [-sorfwxrelnninah]
        Application options:

            -s, --store=<file>               The PStore file containing the spidered HTML
            -o, --out=<dir>                  The name of the output directory

           -rf, --redirects-file=<file>      The name of file to which write HTTP redirect rules
          -wxr, --wxr-export-file=<file>     The name of WXR XML file. If specified comments are exported, otherwise not

            -e, --log-errors                 Whether failed imports should be logged with stacktrace
            -l, --lace=<lace-url>            Runs the importer only for the given lace url
            -n, --limit=<n>                  Limit the imported posts (for debugging purposes)
           -ni, --no-images                  Wether image processing should be skipped
           -na, --no-assets                  Wether asset processing should be skipped

            -h, --help                       Show this message.

## Resources

* [Bundler](http://gembundler.com/)
* [Encoding problems](http://talk-archive.awestruct.org/Stumbling-onto-an-encoding-problem-right-from-the-start-td39.html)

        incompatible character encodings: ASCII-8BIT and UTF-8

